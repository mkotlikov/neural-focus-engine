<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Neural Focus Engine | Generative Phase-Locking</title>
    <style>
        :root {
            --bg: #0f111a;
            --surface: #1a1d2d;
            --primary: #7c4dff;
            --secondary: #00e5ff;
            --text: #e0e0e0;
            --text-dim: #8b9bb4;
        }

        body {
            margin: 0;
            background-color: var(--bg);
            color: var(--text);
            font-family: 'Segoe UI', system-ui, sans-serif;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            justify-content: center;
            min-height: 100vh;
            padding: 2rem 0;
            overflow-y: auto;
        }

        .container {
            width: 90%;
            max-width: 600px;
            background: var(--surface);
            padding: 2rem;
            border-radius: 24px;
            box-shadow: 0 20px 50px rgba(0, 0, 0, 0.5);
            border: 1px solid rgba(255, 255, 255, 0.05);
        }

        header {
            text-align: center;
            margin-bottom: 2rem;
        }

        h1 {
            margin: 0;
            font-size: 1.8rem;
            font-weight: 700;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        p.subtitle {
            margin: 0.5rem 0 0;
            color: var(--text-dim);
            font-size: 0.9rem;
        }

        /* Visualizer */
        canvas {
            width: 100%;
            height: 120px;
            background: #11131e;
            border-radius: 12px;
            margin-bottom: 2rem;
            border: 1px solid rgba(255, 255, 255, 0.05);
        }

        /* Controls */
        .controls {
            display: grid;
            gap: 1.5rem;
        }

        .modes {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 0.5rem;
            background: rgba(0, 0, 0, 0.2);
            padding: 4px;
            border-radius: 12px;
        }

        button.mode-btn {
            background: transparent;
            border: none;
            color: var(--text-dim);
            padding: 12px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.2s;
        }

        button.mode-btn.active {
            background: var(--surface);
            color: var(--secondary);
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
        }

        .slider-group {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .slider-header {
            display: flex;
            justify-content: space-between;
            font-size: 0.85rem;
            color: var(--text-dim);
            font-weight: 600;
        }

        input[type="range"] {
            -webkit-appearance: none;
            width: 100%;
            height: 6px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 3px;
            outline: none;
        }

        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 20px;
            height: 20px;
            background: var(--primary);
            border-radius: 50%;
            cursor: pointer;
            box-shadow: 0 0 10px rgba(124, 77, 255, 0.4);
            transition: transform 0.1s;
        }

        input[type="range"]::-webkit-slider-thumb:hover {
            transform: scale(1.1);
        }

        /* New Select Style */
        select {
            width: 100%;
            padding: 10px;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            color: var(--text);
            font-family: inherit;
            cursor: pointer;
            outline: none;
            font-size: 0.9rem;
            transition: border-color 0.2s;
        }

        select:hover {
            border-color: var(--primary);
        }

        option {
            background: var(--surface);
            color: var(--text);
        }

        .play-btn {
            width: 100%;
            padding: 1rem;
            border: none;
            border-radius: 12px;
            background: var(--primary);
            color: white;
            font-size: 1.1rem;
            font-weight: 700;
            cursor: pointer;
            transition: filter 0.2s;
            margin-top: 1rem;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .play-btn:hover {
            filter: brightness(1.1);
        }

        .play-btn.playing {
            background: #cf3d3d;
        }

        .info {
            margin-top: 1.5rem;
            font-size: 0.8rem;
            color: var(--text-dim);
            text-align: center;
            line-height: 1.4;
        }

        /* Switchboard Styles */
        .advanced-toggle {
            width: 100%;
            background: transparent;
            border: 1px dashed rgba(255, 255, 255, 0.1);
            color: var(--text-dim);
            padding: 8px;
            border-radius: 8px;
            margin-top: 1rem;
            cursor: pointer;
            font-size: 0.8rem;
            transition: all 0.2s;
        }

        .advanced-toggle:hover {
            border-color: var(--primary);
            color: var(--text);
        }

        .switchboard {
            display: none;
            /* Hidden by default */
            margin-top: 1.5rem;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 16px;
            padding: 1.5rem;
            border: 1px solid rgba(255, 255, 255, 0.05);
            gap: 1.5rem;
            grid-template-columns: 1fr 1fr;
        }

        .switchboard.visible {
            display: grid;
            animation: fadeIn 0.3s ease-out;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .sb-section {
            display: flex;
            flex-direction: column;
            gap: 0.8rem;
        }

        .sb-title {
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: var(--secondary);
            font-weight: 700;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            padding-bottom: 4px;
            margin-bottom: 4px;
        }

        .sb-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.8rem;
            color: var(--text-dim);
        }

        .sb-input-group {
            display: flex;
            flex-direction: column;
            gap: 4px;
            flex: 1;
        }

        .sb-io-group {
            grid-column: 1 / -1;
            display: flex;
            gap: 10px;
            margin-top: 10px;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            padding-top: 1rem;
        }

        .sb-btn {
            background: var(--surface);
            border: 1px solid rgba(255, 255, 255, 0.1);
            color: var(--text);
            padding: 8px 12px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.8rem;
            flex: 1;
        }

        .sb-btn:hover {
            background: var(--primary);
            border-color: var(--primary);
        }

        .sb-input-text {
            background: rgba(0, 0, 0, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.1);
            color: var(--text-dim);
            padding: 8px;
            border-radius: 6px;
            width: 100%;
            font-family: inherit;
            font-size: 0.8rem;
        }
    </style>
</head>

<body>

    <div class="container">
        <header>
            <h1>Neural Focus Engine</h1>
            <p class="subtitle">Generative Music • Neural Phase-Locking • Infinite</p>
        </header>

        <canvas id="visualizer"></canvas>

        <div class="controls">
            <div class="modes">
                <button class="mode-btn" onclick="setMode('gamma')">Create</button>
                <button class="mode-btn active" onclick="setMode('focus')">Focus</button>
                <button class="mode-btn" onclick="setMode('relax')">Relax</button>
                <button class="mode-btn" onclick="setMode('sleep')">Sleep</button>
            </div>

            <div class="slider-group">
                <div class="slider-header">
                    <span>Soundscape</span>
                </div>
                <select id="styleSelect" onchange="setStyle(this.value)">
                    <option value="ambient">Ambient Drift</option>
                    <option value="active">Neuro Flow (Fast)</option>
                    <option value="ethereal">Ethereal Planes</option>
                    <option value="techno">Neural Techno</option>
                    <option value="noise">Focus Static (Pink Noise)</option>
                </select>
            </div>

            <div class="slider-group">
                <div class="slider-header">
                    <span>Neural Intensity</span>
                    <span id="intensityVal">50%</span>
                </div>
                <input type="range" min="0" max="100" value="50" id="intensitySlider">
            </div>

            <button class="play-btn" id="playBtn">
                <span id="playIcon">▶</span> <span id="playText">Initialize Engine</span>
            </button>
        </div>

        <button class="advanced-toggle" onclick="toggleSwitchboard()">▼ Advanced Switchboard</button>

        <div class="switchboard" id="switchboard">
            <!-- Name Section -->
            <div class="sb-section"
                style="grid-column: 1 / -1; border-bottom: 1px solid rgba(255,255,255,0.1); padding-bottom: 1rem;">
                <div class="sb-title">Soundscape Name</div>
                <input type="text" class="sb-input-text" id="sbName" placeholder="My Custom Focus Mix"
                    oninput="updateParam('name', this.value)">
            </div>

            <!-- Scale Section -->
            <div class="sb-section">
                <div class="sb-title">Musical Structure</div>
                <div class="sb-input-group">
                    <label class="sb-row">Scale Type</label>
                    <select id="sbScale" onchange="updateParam('scale', this.value)">
                        <option value="major">Pentatonic Major (Uplifting)</option>
                        <option value="minor">Pentatonic Minor (Deep)</option>
                        <option value="dorian">Dorian (Focus/Tech)</option>
                        <option value="phrygian">Phrygian (Tense)</option>
                        <option value="lydian">Lydian (Dreamy)</option>
                    </select>
                </div>
                <div class="sb-input-group">
                    <label class="sb-row">Base Tuning</label>
                    <select id="sbTuning" onchange="updateParam('tuning', this.value)">
                        <option value="440">440 Hz (Standard)</option>
                        <option value="432">432 Hz (Natural)</option>
                    </select>
                </div>
            </div>

            <!-- Rhythm Section -->
            <div class="sb-section">
                <div class="sb-title">Rhythm & Time</div>
                <div class="sb-input-group">
                    <div class="sb-row"><span>BPM</span> <span id="valBPM">60</span></div>
                    <input type="range" min="40" max="160" value="60" oninput="updateParam('bpm', this.value)">
                </div>
                <div class="sb-input-group">
                    <div class="sb-row"><span>Density</span> <span id="valDensity">Medium</span></div>
                    <input type="range" min="1" max="100" value="50" oninput="updateParam('density', this.value)">
                </div>
            </div>

            <!-- Timbre Section -->
            <div class="sb-section">
                <div class="sb-title">Timbre Design</div>
                <div class="sb-input-group">
                    <label class="sb-row">Waveform A</label>
                    <select id="sbWave1" onchange="updateParam('wave1', this.value)">
                        <option value="sine">Sine (Pure)</option>
                        <option value="triangle">Triangle (Soft)</option>
                        <option value="sawtooth">Sawtooth (Sharp)</option>
                        <option value="square">Square (Hollow)</option>
                    </select>
                </div>
                <div class="sb-input-group">
                    <label class="sb-row">Waveform B</label>
                    <select id="sbWave2" onchange="updateParam('wave2', this.value)">
                        <option value="sine">Sine</option>
                        <option value="triangle">Triangle</option>
                        <option value="sawtooth">Sawtooth</option>
                        <option value="square">Square</option>
                    </select>
                </div>
            </div>

            <!-- Envelope Section -->
            <div class="sb-section">
                <div class="sb-title">Envelope</div>
                <div class="sb-input-group">
                    <div class="sb-row"><span>Attack (Fade In)</span> <span id="valAtk">Slow</span></div>
                    <input type="range" min="0" max="100" value="50" oninput="updateParam('attack', this.value)">
                </div>
                <div class="sb-input-group">
                    <div class="sb-row"><span>Release (Tail)</span> <span id="valRel">Long</span></div>
                    <input type="range" min="0" max="100" value="50" oninput="updateParam('release', this.value)">
                </div>
            </div>

            <!-- IO Section -->
            <div class="sb-io-group">
                <button class="sb-btn" onclick="exportSettings()">Copy Shareable URL</button>
                <input type="text" class="sb-input-text" id="importString" placeholder="Paste string or URL...">
                <button class="sb-btn" onclick="importSettings()">Load</button>
            </div>
        </div>

        <div class="info">
            Frequency: <span id="freqDisplay" style="color:var(--secondary)">14 Hz (Beta)</span><br>
            Neural phase locking active. Audio modulated to induce synchronization.
        </div>
    </div>

    <script>
        // --- AUDIO ENGINE CONTEXT ---
        let audioCtx;
        let isPlaying = false;

        // --- NODES ---
        let masterGain;
        let neuralModulatorGain; // The "Gate" that pulses the volume
        let neuralLFO;           // The oscillator controlling the gate
        let reverbNode;

        // --- GENERATIVE STATE ---
        let nextNoteTime = 0;
        let lookahead = 25.0; // ms
        let scheduleAheadTime = 0.1; // s
        let timerID;
        let activeOscillators = [];
        let noiseBuffer; // Reusable buffer for noise

        // --- CONSTANTS ---
        const SCALES = {
            major: [130.81, 146.83, 164.81, 196.00, 220.00, 261.63, 293.66, 329.63, 392.00, 440.00, 523.25, 587.33, 659.25, 783.99, 880.00], // C Major Pentatonic
            minor: [130.81, 155.56, 174.61, 196.00, 233.08, 261.63, 311.13, 349.23, 392.00, 466.16, 523.25, 622.25, 698.46, 783.99, 932.33], // C Minor Pentatonic
            dorian: [146.83, 164.81, 174.61, 196.00, 220.00, 246.94, 261.63, 293.66, 329.63, 349.23, 392.00, 440.00, 493.88, 523.25], // D Dorian
            phrygian: [130.81, 138.59, 155.56, 174.61, 196.00, 207.65, 233.08, 261.63, 277.18, 311.13, 349.23, 392.00, 415.30, 466.16], // C Phrygian
            lydian: [130.81, 146.83, 164.81, 185.00, 196.00, 220.00, 246.94, 261.63, 293.66, 329.63, 369.99, 392.00, 440.00, 493.88] // C Lydian
        };

        const MODES = {
            focus: { freq: 14, type: 'sawtooth', label: '14 Hz (Beta)' }, // Alert, sharp pulses
            relax: { freq: 10, type: 'sine', label: '10 Hz (Alpha)' },    // Calm, smooth pulses
            sleep: { freq: 2, type: 'sine', label: '2 Hz (Delta)' },      // Deep, slow waves
            gamma: { freq: 40, type: 'sawtooth', label: '40 Hz (Gamma)' }  // Peak concentration
        };

        let currentMode = 'focus';

        // Default Params (Ambient)
        let currentParams = {
            name: 'Custom Mix',
            scale: 'major',
            tuning: 440,
            bpm: 60,
            density: 50,
            wave1: 'sine',
            wave2: 'triangle',
            attack: 50,
            release: 50
        };

        // --- SWITCHBOARD LOGIC ---
        // Check for URL config on load
        window.addEventListener('DOMContentLoaded', () => {
            const params = new URLSearchParams(window.location.search);
            const config = params.get('config');
            if (config) {
                try {
                    const parsed = JSON.parse(atob(config));
                    Object.keys(currentParams).forEach(k => {
                        if (parsed[k] !== undefined) currentParams[k] = parsed[k];
                    });
                    syncUI();

                    // If name exists, show it in the header momentarily or alert? 
                    // Let's just update the name field (handled by syncUI).

                    // Auto-open and focus
                    const sb = document.getElementById('switchboard');
                    if (!sb.classList.contains('visible')) {
                        toggleSwitchboard();
                    }
                    setTimeout(() => {
                        sb.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    }, 500); // Small delay to ensure render
                } catch (e) {
                    console.error("Invalid URL Config", e);
                }
            }
        });

        function toggleSwitchboard() {
            const sb = document.getElementById('switchboard');
            sb.classList.toggle('visible');
            const btn = document.querySelector('.advanced-toggle');
            btn.innerText = sb.classList.contains('visible') ? '▲ Hide Switchboard' : '▼ Advanced Switchboard';
        }

        function updateParam(key, value) {
            currentParams[key] = value;

            // Update UI Labels
            if (key === 'bpm') document.getElementById('valBPM').innerText = value;
            if (key === 'density') {
                const map = value < 30 ? 'Sparse' : value > 70 ? 'Dense' : 'Medium';
                document.getElementById('valDensity').innerText = map;
            }
            if (key === 'attack') document.getElementById('valAtk').innerText = value + '%';
            if (key === 'release') document.getElementById('valRel').innerText = value + '%';
        }

        function exportSettings() {
            const str = btoa(JSON.stringify(currentParams));
            // Construct full URL
            const url = `${window.location.origin}${window.location.pathname}?config=${str}`;
            navigator.clipboard.writeText(url);
            alert("Shareable URL copied to clipboard!");
        }

        function importSettings() {
            let val = document.getElementById('importString').value.trim();
            // Handle if user pasted full URL by extracting the config param
            if (val.includes('config=')) {
                try {
                    val = val.split('config=')[1];
                } catch (e) { }
            }

            try {
                const params = JSON.parse(atob(val));
                // Validate keys safely
                Object.keys(currentParams).forEach(k => {
                    if (params[k] !== undefined) currentParams[k] = params[k];
                });
                syncUI();
                alert(`Loaded: ${currentParams.name || 'Configuration'}`);
            } catch (e) {
                alert("Invalid Configuration String or URL");
            }
        }

        function syncUI() {
            // Update all inputs to match currentParams
            document.getElementById('sbName').value = currentParams.name || '';
            document.getElementById('sbScale').value = currentParams.scale;
            document.getElementById('sbTuning').value = currentParams.tuning;
            document.getElementById('sbWave1').value = currentParams.wave1;
            document.getElementById('sbWave2').value = currentParams.wave2;

            // Trigger manual updates for sliders to update text
            const bpmSlider = document.querySelector('input[oninput*="bpm"]');
            bpmSlider.value = currentParams.bpm;
            updateParam('bpm', currentParams.bpm);

            const densitySlider = document.querySelector('input[oninput*="density"]');
            densitySlider.value = currentParams.density;
            updateParam('density', currentParams.density);

            const atkSlider = document.querySelector('input[oninput*="attack"]');
            atkSlider.value = currentParams.attack;
            updateParam('attack', currentParams.attack);

            const relSlider = document.querySelector('input[oninput*="release"]');
            relSlider.value = currentParams.release;
            updateParam('release', currentParams.release);
        }

        // --- UI ELEMENTS ---
        const canvas = document.getElementById('visualizer');
        const ctx = canvas.getContext('2d');
        const playBtn = document.getElementById('playBtn');
        const playText = document.getElementById('playText');
        const playIcon = document.getElementById('playIcon');
        const intensitySlider = document.getElementById('intensitySlider');
        const intensityVal = document.getElementById('intensityVal');
        const freqDisplay = document.getElementById('freqDisplay');
        const modeBtns = document.querySelectorAll('.mode-btn');

        // --- INITIALIZATION ---

        async function initAudio() {
            const AudioContext = window.AudioContext || window.webkitAudioContext;
            audioCtx = new AudioContext();

            // 1. Create Master Output Chain
            masterGain = audioCtx.createGain();
            masterGain.gain.value = 1.0;

            // 2. Create Neural Modulator (The Core Tech)
            // The music goes into this gain node, and this gain node is automated by the LFO
            neuralModulatorGain = audioCtx.createGain();
            neuralModulatorGain.gain.value = 1.0;

            // 3. Create Reverb (Impulse Response)
            reverbNode = audioCtx.createConvolver();
            reverbNode.buffer = await createImpulseResponse();

            // 4. Wiring: Music -> Reverb -> NeuralGate -> Master -> Out
            // (We mix dry and wet signal for the generative synth separately)

            reverbNode.connect(neuralModulatorGain);
            neuralModulatorGain.connect(masterGain);
            masterGain.connect(audioCtx.destination);

            // 5. Start the Neural LFO
            startNeuralLFO();

            // 6. Generate White Noise Buffer (cached)
            const bufferSize = audioCtx.sampleRate * 2; // 2 seconds
            noiseBuffer = audioCtx.createBuffer(1, bufferSize, audioCtx.sampleRate);
            const data = noiseBuffer.getChannelData(0);
            for (let i = 0; i < bufferSize; i++) {
                data[i] = Math.random() * 2 - 1;
            }
        }

        // --- NEURAL PHASE LOCKING LOGIC ---

        function startNeuralLFO() {
            if (neuralLFO) neuralLFO.stop();

            // The LFO (Low Frequency Oscillator) that creates the "beat"
            neuralLFO = audioCtx.createOscillator();
            neuralLFO.frequency.value = MODES[currentMode].freq;
            neuralLFO.type = MODES[currentMode].type; // Set shape (sine/sawtooth)

            // To modulate gain (volume), we need to map the LFO (-1 to 1) 
            // to a Gain value (e.g., 0.5 to 1.0).
            // We use a separate GainNode to control the *depth* of this modulation.

            const lfoGain = audioCtx.createGain();
            lfoGain.gain.value = 0; // Starts at 0, controlled by slider

            // Connect LFO -> LfoGain -> NeuralModulatorGain.gain
            neuralLFO.connect(lfoGain);
            lfoGain.connect(neuralModulatorGain.gain);

            neuralLFO.start();

            // Store reference to lfoGain so slider can change it
            neuralLFO.depthNode = lfoGain;

            updateIntensity(); // Apply initial slider value
        }

        function setStyle(style) {
            // Preset Logic: Applying profiles to the Switchboard
            switch (style) {
                case 'ambient':
                    currentParams = { scale: 'major', tuning: 440, bpm: 60, density: 40, wave1: 'sine', wave2: 'triangle', attack: 60, release: 80 };
                    break;
                case 'active':
                    currentParams = { scale: 'dorian', tuning: 440, bpm: 110, density: 75, wave1: 'triangle', wave2: 'sawtooth', attack: 10, release: 30 };
                    break;
                case 'ethereal':
                    currentParams = { scale: 'lydian', tuning: 432, bpm: 40, density: 20, wave1: 'sine', wave2: 'sine', attack: 80, release: 95 };
                    break;
                case 'techno':
                    currentParams = { scale: 'phrygian', tuning: 440, bpm: 128, density: 85, wave1: 'square', wave2: 'sawtooth', attack: 5, release: 25 };
                    break;
                case 'noise':
                    // Noise is special, but we set some defaults
                    currentParams = { scale: 'minor', tuning: 440, bpm: 30, density: 100, wave1: 'sine', wave2: 'sine', attack: 50, release: 50 };
                    break;
            }
            // If noise is selected, we track it for the internal switch (or we could make 'type' a param)
            // For now, we rely on the Select element value or check currentParams if we wanted. 
            // Actually, let's store the 'style' strictly for the "Noise" special logic in playNote.
            // But 'Noise' mode logic is invasive. Let's handle it by checking the Select box value directly in playNote 
            // OR we add a 'mode' to params. 

            // To keep it simple: We keep the dropdown value as the source of truth for "Special Modes" (Noise),
            // but for all "Musical Modes", we use params.

            syncUI();
        }

        function updateIntensity() {
            if (!neuralLFO || !neuralLFO.depthNode) return;

            // Slider 0-100 mapped to modulation depth 0.0 - 0.5
            // If depth is 0.5, gain oscillates between 1.0 +/- 0.5 => (0.5 to 1.5)
            // Note: We want to dip volume, not clip it. 
            // A safer modulation is subtractive or centered. 
            // Here we simply modulate around the base gain.
            const val = parseInt(intensitySlider.value) / 100;
            intensityVal.innerText = `${parseInt(intensitySlider.value)}%`;

            // Smooth transition
            const now = audioCtx.currentTime;
            neuralLFO.depthNode.gain.setTargetAtTime(val * 0.3, now, 0.1);
        }

        function setMode(mode) {
            currentMode = mode;

            // Update UI
            modeBtns.forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            freqDisplay.innerText = MODES[mode].label;

            // Update Audio
            if (audioCtx && neuralLFO) {
                const now = audioCtx.currentTime;
                // Ramp frequency smoothly
                neuralLFO.frequency.setTargetAtTime(MODES[mode].freq, now, 1.0);
                neuralLFO.type = MODES[mode].type; // Update shape instantly
            }
        }

        // --- GENERATIVE MUSIC ENGINE ---

        function playNote(time) {
            const style = document.getElementById('styleSelect').value;

            // SPECIAL HANDLER FOR NOISE
            if (style === 'noise') {
                const source = audioCtx.createBufferSource();
                source.buffer = noiseBuffer;
                source.loop = true;

                // Color the noise (Lowpass filter makes it Pink/Brown)
                const filter = audioCtx.createBiquadFilter();
                filter.type = 'lowpass';
                filter.frequency.value = 200 + Math.random() * 400; // Varying 'wind' tones

                const noiseGain = audioCtx.createGain();

                // Fade in/out for continuous texture
                const duration = 2.0 + Math.random();
                const attack = 1.0;
                const release = 1.0;

                noiseGain.gain.setValueAtTime(0, time);
                noiseGain.gain.linearRampToValueAtTime(0.8, time + attack);
                noiseGain.gain.exponentialRampToValueAtTime(0.001, time + duration); // Fade out

                // Connections (Parallel Dry/Wet for Loudness)
                source.connect(filter);
                filter.connect(noiseGain);
                noiseGain.connect(neuralModulatorGain); // Dry
                noiseGain.connect(reverbNode);          // Wet

                source.start(time);
                source.stop(time + duration + 0.5);

                return;
            }

            // 1. Pick a note from Valid Scale
            const scaleName = currentParams.scale || 'major';
            let noteScale = SCALES[scaleName] || SCALES.major;

            const rawFreq = noteScale[Math.floor(Math.random() * noteScale.length)];

            // Apply Tuning Shift
            const tuningRatio = (currentParams.tuning || 440) / 440;
            const freq = rawFreq * tuningRatio;

            // DURATION & ENVELOPE LOGIC
            // Map 0-100 sliders to useful time values
            const attack = 0.01 + (currentParams.attack / 100) * 3.0;
            const release = 0.1 + (currentParams.release / 100) * 8.0;
            const duration = attack + release; // Visual duration

            const wave1 = currentParams.wave1 || 'sine';
            const wave2 = currentParams.wave2 || 'triangle';

            const vol = 0.4 + Math.random() * 0.1;

            // 2. Create Oscillators
            const osc1 = audioCtx.createOscillator();
            const osc2 = audioCtx.createOscillator();

            osc1.type = wave1;
            osc2.type = wave2;

            osc1.frequency.value = freq;

            // Detune / Sub-bass logic
            osc2.frequency.value = freq * 1.005;

            // If Techno (High BPM + Square/Saw), add sub-bass
            if (currentParams.bpm > 115 && (wave1 === 'square' || wave2 === 'square')) {
                osc2.frequency.value = freq * 0.5;
            }

            // 3. Envelope (ADSR)
            const noteGain = audioCtx.createGain();

            noteGain.gain.setValueAtTime(0, time);
            noteGain.gain.linearRampToValueAtTime(vol, time + attack);
            noteGain.gain.exponentialRampToValueAtTime(0.001, time + attack + release);

            // 4. Connect (Parallel Dry/Wet)
            osc1.connect(noteGain);
            osc2.connect(noteGain);
            noteGain.connect(neuralModulatorGain); // Dry
            noteGain.connect(reverbNode);          // Wet

            // 5. Start/Stop
            osc1.start(time);
            osc2.start(time);
            osc1.stop(time + attack + release + 1);
            osc2.stop(time + attack + release + 1);

            // Cleanup visualization list
            activeOscillators.push({
                freq: freq,
                startTime: time,
                duration: attack + release,
                peak: vol
            });
        }

        function scheduler() {
            while (nextNoteTime < audioCtx.currentTime + scheduleAheadTime) {
                const style = document.getElementById('styleSelect').value;
                let nextGap;

                if (style === 'noise') {
                    nextGap = 1.5;
                    playNote(nextNoteTime);
                } else {
                    // BPM & Density Logic
                    const beatDur = 60 / currentParams.bpm;
                    const density = currentParams.density / 100;

                    if (Math.random() < density) {
                        playNote(nextNoteTime);
                    }

                    nextGap = beatDur;

                    // Sparse logic for low density
                    if (density < 0.3 && Math.random() > 0.5) nextGap *= 2;
                }

                nextNoteTime += nextGap;
            }
            timerID = window.setTimeout(scheduler, lookahead);
        }

        // --- UTILITIES ---

        // Generates a synthetic reverb impulse response (Algorithmic Reverb)
        async function createImpulseResponse() {
            const sampleRate = audioCtx.sampleRate;
            const length = sampleRate * 3.0; // 3 seconds tail
            const impulse = audioCtx.createBuffer(2, length, sampleRate);
            const left = impulse.getChannelData(0);
            const right = impulse.getChannelData(1);

            for (let i = 0; i < length; i++) {
                // Exponential decay noise
                const decay = Math.pow(1 - i / length, 5);
                left[i] = (Math.random() * 2 - 1) * decay;
                right[i] = (Math.random() * 2 - 1) * decay;
            }
            return impulse;
        }

        // --- VISUALIZATION ---

        function draw() {
            requestAnimationFrame(draw);

            // Clear
            ctx.fillStyle = '#11131e';
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            if (!isPlaying) return;

            const w = canvas.width;
            const h = canvas.height;
            const now = audioCtx.currentTime;

            // 1. Draw Modulator Wave (The "Brain" Pulse)
            ctx.beginPath();
            ctx.strokeStyle = '#2a2d3d';
            ctx.lineWidth = 2;

            const lfoFreq = MODES[currentMode].freq;
            for (let x = 0; x < w; x++) {
                // Simulate the LFO wave
                const y = h / 2 + Math.sin(x * 0.05 + now * lfoFreq) * (h / 3);
                if (x === 0) ctx.moveTo(x, y);
                else ctx.lineTo(x, y);
            }
            ctx.stroke();

            // 2. Draw Active Notes (The "Music")
            activeOscillators = activeOscillators.filter(o => now < o.startTime + o.duration);

            activeOscillators.forEach(osc => {
                const age = (now - osc.startTime) / osc.duration; // 0 to 1
                const x = (osc.freq / 1000) * w; // Map freq to X

                // Fade in/out alpha
                let alpha = 0;
                if (age < 0.2) alpha = age / 0.2;
                else alpha = 1 - (age - 0.2) / 0.8;

                ctx.fillStyle = `rgba(124, 77, 255, ${alpha})`;

                const radius = 5 + (osc.peak * 200);

                ctx.beginPath();
                ctx.arc(x, h / 2, radius, 0, Math.PI * 2);
                ctx.fill();
            });
        }

        // Resize canvas
        function resizeCanvas() {
            canvas.width = canvas.offsetWidth;
            canvas.height = canvas.offsetHeight;
        }
        window.addEventListener('resize', resizeCanvas);
        resizeCanvas();
        draw(); // Start loop

        // --- EVENT LISTENERS ---

        intensitySlider.addEventListener('input', updateIntensity);

        playBtn.addEventListener('click', async () => {
            if (!audioCtx) await initAudio();

            if (audioCtx.state === 'suspended') {
                await audioCtx.resume();
            }

            isPlaying = !isPlaying;

            if (isPlaying) {
                // START
                playText.innerText = "Stop Engine";
                playIcon.innerText = "■";
                playBtn.classList.add('playing');

                nextNoteTime = audioCtx.currentTime;
                scheduler();

                // Fade in master
                masterGain.gain.setTargetAtTime(0.5, audioCtx.currentTime, 1);
            } else {
                // STOP
                playText.innerText = "Initialize Engine";
                playIcon.innerText = "▶";
                playBtn.classList.remove('playing');

                clearTimeout(timerID);
                masterGain.gain.setTargetAtTime(0, audioCtx.currentTime, 0.1);
            }
        });

    </script>
</body>

</html>