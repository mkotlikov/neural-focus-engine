<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Neural Phase Locking Focus Engine</title>
    <style>
        :root {
            --bg-color: #0f172a;
            --text-color: #e2e8f0;
            --slate-300: #cbd5e1;
            --slate-400: #94a3b8;
            --slate-500: #64748b;
            --slate-600: #475569;
            --slate-700: #334155;
            --slate-800: #1e293b;
            --slate-950: #020617;
            --blue-400: #60a5fa;
            --blue-500: #3b82f6;
            --blue-600: #2563eb;
            --emerald-400: #34d399;
            --purple-400: #c084fc;
            --sky-400: #38bdf8;
            --red-400: #f87171;
            --red-500: #ef4444;
        }

        body {
            background-color: var(--bg-color);
            color: var(--text-color);
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            margin: 0;
            padding: 1rem;
            box-sizing: border-box;
        }

        /* Initial Setup for Canvas */
        * {
            box-sizing: border-box;
        }

        /* Typography */
        h1 {
            font-size: 2.25rem;
            line-height: 2.5rem;
            font-weight: 700;
            letter-spacing: -0.025em;
            margin-bottom: 0.5rem;
            background: linear-gradient(to right, var(--blue-400), var(--emerald-400));
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
        }

        h3 {
            font-size: 1.125rem;
            line-height: 1.75rem;
            font-weight: 600;
            color: #93c5fd;
            /* blue-300 */
            border-bottom: 1px solid var(--slate-700);
            padding-bottom: 0.5rem;
            margin-top: 0;
            margin-bottom: 1.5rem;
        }

        .subtitle {
            color: var(--slate-400);
            font-size: 0.875rem;
            line-height: 1.25rem;
            margin-top: 0;
        }

        .label {
            font-size: 0.75rem;
            line-height: 1rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: var(--slate-500);
        }

        .value {
            font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace;
            font-size: 0.75rem;
        }

        .description {
            font-size: 0.75rem;
            color: var(--slate-600);
            margin-top: 0.25rem;
            margin-bottom: 0;
        }

        /* Layout */
        .container {
            width: 100%;
            max-width: 42rem;
            display: grid;
            gap: 1.5rem;
        }

        .grid-2 {
            display: grid;
            grid-template-columns: 1fr;
            gap: 1.5rem;
        }

        @media (min-width: 768px) {
            .grid-2 {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        /* Components */
        .card {
            background: rgba(30, 41, 59, 0.5);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(148, 163, 184, 0.1);
            border-radius: 0.75rem;
            padding: 1.5rem;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
        }

        .control-block {
            margin-bottom: 1.5rem;
        }

        .control-block:last-child {
            margin-bottom: 0;
        }

        .flex-between {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.25rem;
        }

        /* Inputs */
        input[type=range] {
            -webkit-appearance: none;
            width: 100%;
            background: transparent;
            margin: 0.5rem 0;
        }

        input[type=range]:focus {
            outline: none;
        }

        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none;
            height: 16px;
            width: 16px;
            border-radius: 50%;
            background: var(--blue-400);
            cursor: pointer;
            margin-top: -6px;
            box-shadow: 0 0 10px rgba(96, 165, 250, 0.5);
        }

        input[type=range]::-webkit-slider-runnable-track {
            width: 100%;
            height: 4px;
            cursor: pointer;
            background: var(--slate-700);
            border-radius: 2px;
        }

        /* Buttons */
        .btn-main {
            background-color: var(--blue-600);
            color: white;
            font-weight: 700;
            padding: 0.75rem 2rem;
            border-radius: 9999px;
            transition: all 0.2s;
            box-shadow: 0 0 20px rgba(37, 99, 235, 0.3);
            display: flex;
            align-items: center;
            gap: 0.5rem;
            border: none;
            cursor: pointer;
            margin: 0 auto;
        }

        .btn-main:hover {
            background-color: var(--blue-500);
            box-shadow: 0 0 30px rgba(37, 99, 235, 0.5);
        }

        .btn-main.active {
            background-color: var(--red-500);
            box-shadow: 0 0 20px rgba(239, 68, 68, 0.3);
        }

        .btn-main.active:hover {
            background-color: var(--red-400);
            box-shadow: 0 0 30px rgba(239, 68, 68, 0.5);
        }

        .btn-preset {
            padding: 0.5rem 1rem;
            background-color: var(--slate-800);
            color: var(--text-color);
            font-size: 0.75rem;
            border: 1px solid var(--slate-700);
            border-radius: 0.25rem;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .btn-preset:hover {
            background-color: var(--slate-700);
        }

        .button-group {
            display: flex;
            justify-content: center;
            gap: 1rem;
            margin-top: 0.5rem;
        }

        /* Visualizer */
        #visualizer {
            width: 100%;
            height: 8rem;
            background-color: var(--slate-950);
            border-radius: 0.5rem;
            border: 1px solid var(--slate-800);
            margin-bottom: 1rem;
        }

        /* Utility Colors */
        .text-blue {
            color: var(--blue-400);
        }

        .text-emerald {
            color: var(--emerald-400);
        }

        .text-purple {
            color: var(--purple-400);
        }

        .text-slate-300 {
            color: var(--slate-300);
        }
    </style>
</head>

<body>

    <!-- Header -->
    <div style="text-align: center; margin-bottom: 2rem;">
        <h1>Neural Phase Locking</h1>
        <p class="subtitle">Dual-Layer Entrainment Engine (Binaural + AM)</p>
    </div>

    <!-- Main Interface -->
    <div class="container">

        <!-- Visualizer -->
        <div class="card">
            <canvas id="visualizer"></canvas>

            <div style="display: flex; justify-content: center;">
                <button id="playBtn" class="btn-main">
                    <span id="playIcon">â–¶</span> <span id="playText">Initialize Audio Engine</span>
                </button>
            </div>
        </div>

        <!-- Controls Grid -->
        <div class="grid-2">

            <!-- Frequencies -->
            <div class="card">
                <h3>Frequency Controls</h3>

                <!-- Carrier -->
                <div class="control-block">
                    <div class="flex-between">
                        <label class="label">Carrier Tone</label>
                        <span id="carrierVal" class="value text-blue">200 Hz</span>
                    </div>
                    <input type="range" id="carrierSlider" min="100" max="400" value="200" step="1">
                    <p class="description">Base pitch.</p>
                </div>

                <!-- Binaural Beat -->
                <div class="control-block">
                    <div class="flex-between">
                        <label class="label">Binaural Beat</label>
                        <span id="beatVal" class="value text-emerald">14 Hz (Beta)</span>
                    </div>
                    <input type="range" id="beatSlider" min="1" max="40" value="14" step="0.5">
                    <p class="description">Focus (14Hz) to Flow (10Hz).</p>
                </div>

                <!-- Phase Lock (AM) -->
                <div class="control-block">
                    <div class="flex-between">
                        <label class="label">Phase Lock (AM)</label>
                        <span id="amVal" class="value text-purple">40 Hz (Gamma)</span>
                    </div>
                    <input type="range" id="amSlider" min="1" max="60" value="40" step="1">
                    <p class="description">Gamma (40Hz) for binding.</p>
                </div>
            </div>

            <!-- Mixer -->
            <div class="card">
                <h3>Mixer</h3>

                <!-- Tone Vol -->
                <div class="control-block">
                    <div class="flex-between">
                        <label class="label">Tone Volume</label>
                        <span id="toneVolVal" class="value text-slate-300">20%</span>
                    </div>
                    <input type="range" id="toneVolSlider" min="0" max="1" value="0.2" step="0.01">
                </div>

                <!-- Noise Vol -->
                <div class="control-block">
                    <div class="flex-between">
                        <label class="label">Brown Noise Volume</label>
                        <span id="noiseVolVal" class="value text-slate-300">60%</span>
                    </div>
                    <input type="range" id="noiseVolSlider" min="0" max="1" value="0.6" step="0.01">
                </div>

                <!-- AM Depth -->
                <div class="control-block">
                    <div class="flex-between">
                        <label class="label">AM Depth (Pulse)</label>
                        <span id="amDepthVal" class="value text-purple">40%</span>
                    </div>
                    <input type="range" id="amDepthSlider" min="0" max="1" value="0.4" step="0.05">
                    <p class="description">Pulse intensity.</p>
                </div>
            </div>
        </div>

        <!-- Presets -->
        <div class="button-group">
            <button onclick="setPreset('focus')" class="btn-preset">ðŸš€ Deep Focus</button>
            <button onclick="setPreset('flow')" class="btn-preset">ðŸŒŠ Flow State</button>
            <button onclick="setPreset('sleep')" class="btn-preset">ðŸŒ™ Relaxation</button>
        </div>

    </div>

    <script>
        // --- Audio Context & Nodes ---
        let ctx;
        let isPlaying = false;

        // Nodes
        let leftOsc, rightOsc;
        let leftPanner, rightPanner;
        let amOsc, amGain; // AM (Phase Locking) LFO and Gain
        let noiseSource, noiseGain;
        let masterGain;
        let analyser;

        // --- Configuration State (Recommended Defaults) ---
        const state = {
            carrierFreq: 200,
            beatFreq: 14,       // Deep Focus default
            amFreq: 40,         // Gamma default
            toneVol: 0.2,       // Low tone volume
            noiseVol: 0.6,      // High masking noise
            amDepth: 0.4        // Moderate pulse
        };

        // --- Brown Noise Generator (Improved Buffer Method) ---
        function createBrownNoiseBuffer() {
            const bufferSize = ctx.sampleRate * 5; // 5 seconds buffer
            const buffer = ctx.createBuffer(1, bufferSize, ctx.sampleRate);
            const data = buffer.getChannelData(0);

            let lastOut = 0;
            for (let i = 0; i < bufferSize; i++) {
                const white = Math.random() * 2 - 1;
                data[i] = (lastOut + (0.02 * white)) / 1.02; // Simple integration for Brown noise
                lastOut = data[i];
                data[i] *= 3.5; // Compensate for gain loss
            }
            return buffer;
        }

        // --- Audio Engine Initialization ---
        function initAudio() {
            if (ctx) return;

            const AudioContext = window.AudioContext || window.webkitAudioContext;
            ctx = new AudioContext();

            // Master Mix
            masterGain = ctx.createGain();
            masterGain.connect(ctx.destination);
            masterGain.gain.value = 0.8; // Headroom

            // Analyser (Visualizer)
            analyser = ctx.createAnalyser();
            analyser.fftSize = 2048;
            masterGain.connect(analyser);

            // 1. Brown Noise Setup
            const noiseBuffer = createBrownNoiseBuffer();
            noiseSource = ctx.createBufferSource();
            noiseSource.buffer = noiseBuffer;
            noiseSource.loop = true;

            noiseGain = ctx.createGain();
            noiseGain.gain.value = state.noiseVol;
            noiseSource.connect(noiseGain);
            noiseGain.connect(masterGain);
            noiseSource.start();

            // 2. Binaural & AM Setup
            // Left Channel
            leftOsc = ctx.createOscillator();
            leftOsc.type = 'sine';
            leftOsc.frequency.value = state.carrierFreq;

            const leftAmGain = ctx.createGain();
            leftAmGain.gain.value = state.toneVol;

            leftPanner = ctx.createStereoPanner();
            leftPanner.pan.value = -1; // Hard Left

            leftOsc.connect(leftAmGain).connect(leftPanner).connect(masterGain);

            // Right Channel
            rightOsc = ctx.createOscillator();
            rightOsc.type = 'sine';
            rightOsc.frequency.value = state.carrierFreq + state.beatFreq;

            const rightAmGain = ctx.createGain();
            rightAmGain.gain.value = state.toneVol;

            rightPanner = ctx.createStereoPanner();
            rightPanner.pan.value = 1; // Hard Right

            rightOsc.connect(rightAmGain).connect(rightPanner).connect(masterGain);

            // 3. Neural Phase Locking (AM LFO)
            amOsc = ctx.createOscillator();
            amOsc.type = 'sine';
            amOsc.frequency.value = state.amFreq;

            // AM Gain controls the *strength* of the modulation
            amGain = ctx.createGain();
            amGain.gain.value = state.amDepth * state.toneVol;

            // Connect LFO to the Gain parameters
            amOsc.connect(amGain);
            amGain.connect(leftAmGain.gain);
            amGain.connect(rightAmGain.gain);

            leftOsc.start();
            rightOsc.start();
            amOsc.start();

            // Store references
            window.audioNodes = {
                leftOsc, rightOsc,
                leftAmGain, rightAmGain,
                amOsc, amGain,
                noiseGain
            };
        }

        function togglePlay() {
            const btn = document.getElementById('playBtn');
            const playText = document.getElementById('playText');
            const playIcon = document.getElementById('playIcon');

            if (!isPlaying) {
                initAudio();
                if (ctx.state === 'suspended') ctx.resume();
                isPlaying = true;
                btn.classList.add('active'); // Changed to use simple class toggle
                playText.innerText = "Stop Engine";
                playIcon.innerText = "â¹";
                drawVisualizer();
            } else {
                ctx.suspend();
                isPlaying = false;
                btn.classList.remove('active');
                playText.innerText = "Resume Engine";
                playIcon.innerText = "â–¶";
            }
        }

        // --- Parameter Updates ---
        function updateAudioParams() {
            if (!ctx || !window.audioNodes) return;
            const nodes = window.audioNodes;
            const now = ctx.currentTime;
            const ramp = 0.1;

            // Frequencies
            nodes.leftOsc.frequency.setTargetAtTime(state.carrierFreq, now, ramp);
            nodes.rightOsc.frequency.setTargetAtTime(state.carrierFreq + state.beatFreq, now, ramp);
            nodes.amOsc.frequency.setTargetAtTime(state.amFreq, now, ramp);

            // Volumes
            nodes.noiseGain.gain.setTargetAtTime(state.noiseVol, now, ramp);

            nodes.leftAmGain.gain.setTargetAtTime(state.toneVol, now, ramp);
            nodes.rightAmGain.gain.setTargetAtTime(state.toneVol, now, ramp);

            // Recalculate AM Depth relative to volume
            nodes.amGain.gain.setTargetAtTime(state.amDepth * state.toneVol, now, ramp);
        }

        // --- UI Event Listeners ---
        document.getElementById('playBtn').addEventListener('click', togglePlay);

        // Sliders
        const createListener = (id, stateKey, displayId, suffix = '') => {
            const el = document.getElementById(id);
            const disp = document.getElementById(displayId);
            el.addEventListener('input', (e) => {
                const val = parseFloat(e.target.value);
                state[stateKey] = val;
                disp.innerText = val + suffix;
                updateAudioParams();
            });
        };

        createListener('carrierSlider', 'carrierFreq', 'carrierVal', ' Hz');
        createListener('beatSlider', 'beatFreq', 'beatVal', ' Hz');
        createListener('amSlider', 'amFreq', 'amVal', ' Hz');

        // Volume listeners 
        document.getElementById('toneVolSlider').addEventListener('input', (e) => {
            state.toneVol = parseFloat(e.target.value);
            document.getElementById('toneVolVal').innerText = Math.round(state.toneVol * 100) + '%';
            updateAudioParams();
        });
        document.getElementById('noiseVolSlider').addEventListener('input', (e) => {
            state.noiseVol = parseFloat(e.target.value);
            document.getElementById('noiseVolVal').innerText = Math.round(state.noiseVol * 100) + '%';
            updateAudioParams();
        });
        document.getElementById('amDepthSlider').addEventListener('input', (e) => {
            state.amDepth = parseFloat(e.target.value);
            document.getElementById('amDepthVal').innerText = Math.round(state.amDepth * 100) + '%';
            updateAudioParams();
        });

        // --- Visualizer ---
        function drawVisualizer() {
            if (!isPlaying) return;
            requestAnimationFrame(drawVisualizer);

            const canvas = document.getElementById('visualizer');
            const canvasCtx = canvas.getContext('2d');
            const width = canvas.width = canvas.offsetWidth;
            const height = canvas.height = canvas.offsetHeight;

            const bufferLength = analyser.frequencyBinCount;
            const dataArray = new Uint8Array(bufferLength);

            analyser.getByteTimeDomainData(dataArray);

            canvasCtx.fillStyle = 'rgb(2, 6, 23)'; // slate-950
            canvasCtx.fillRect(0, 0, width, height);

            canvasCtx.lineWidth = 2;
            canvasCtx.strokeStyle = 'rgb(56, 189, 248)'; // sky-400

            canvasCtx.beginPath();

            const sliceWidth = width * 1.0 / bufferLength;
            let x = 0;

            for (let i = 0; i < bufferLength; i++) {
                const v = dataArray[i] / 128.0;
                const y = v * height / 2;

                if (i === 0) {
                    canvasCtx.moveTo(x, y);
                } else {
                    canvasCtx.lineTo(x, y);
                }

                x += sliceWidth;
            }

            canvasCtx.lineTo(canvas.width, canvas.height / 2);
            canvasCtx.stroke();
        }

        // --- Presets ---
        window.setPreset = (type) => {
            const presets = {
                focus: { beat: 14, am: 40, beatText: "14 Hz (Beta)", amText: "40 Hz (Gamma)" },
                flow: { beat: 10, am: 20, beatText: "10 Hz (Alpha)", amText: "20 Hz (Beta)" },
                sleep: { beat: 5, am: 4, beatText: "5 Hz (Theta)", amText: "4 Hz (Theta)" }
            };

            const p = presets[type];
            state.beatFreq = p.beat;
            state.amFreq = p.am;

            document.getElementById('beatSlider').value = p.beat;
            document.getElementById('beatVal').innerText = p.beatText;
            document.getElementById('amSlider').value = p.am;
            document.getElementById('amVal').innerText = p.amText;

            updateAudioParams();
        };

    </script>
</body>

</html>